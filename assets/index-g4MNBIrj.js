(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const h of n.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&r(h)}).observe(document,{childList:!0,subtree:!0});function o(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(i){if(i.ep)return;i.ep=!0;const n=o(i);fetch(i.href,n)}})();const A=document.getElementById("canvas"),s=A.getContext("2d"),N=4,U=144*N,gt=144*N;A.width=U;A.height=gt;const pt=1.5,vt=96,Z={useTankDrive:!1};let T=null;window.addEventListener("gamepadconnected",e=>{T=e.gamepad.index});window.addEventListener("gamepaddisconnected",e=>{T===e.gamepad.index&&(T=null)});function tt(){const e=navigator.getGamepads?navigator.getGamepads():[];return e&&T!=null&&e[T]?e[T]:null}const d=Object.create(null),u=Object.create(null);document.addEventListener("keydown",e=>{d[e.key]=!0});document.addEventListener("keyup",e=>{d[e.key]=!1,u[e.key]=!1});const E=.15;function et(e){let t=0,o=0,r=0;p("1")&&(u[1]=!0,r=-1),p("2")&&(u[2]=!0,r=1),p("3")&&(u[3]=!0,t=-1),p("4")&&(u[4]=!0,t=1),p("5")&&(u[5]=!0,o=-1),p("6")&&(u[6]=!0,o=1),p("h")&&(u.h=!0,e.odomData=!e.odomData),p("r")&&(u.r=!0,Z.useTankDrive=!Z.useTankDrive),e.maxDecel+=o,e.maxSpeed+=r,e.maxAccel+=t}let b=0;function it(e){return p("f")&&(u.f=!0,b++,b>=e.length&&(b=0)),e[b].render(),e[b]}function wt(e,t,o,r){const i=e.axes,n=M(-i[1],E),h=M(i[2],E);t.tankDrive(n+h,n-h,o,r)}function _t(e,t,o,r){const i=e.axes,n=M(-i[1],E),h=M(-i[0],E),l=M(-i[2],E);let a=n+h+l,m=n-h-l,x=n-h+l,w=n+h-l;t.mecanumDrive(a,m,x,w,o,r)}function yt(e,t,o){const r=tt();if(r)return wt(r,e,t,o);let i=0,n=0;d.w&&(i+=1),d.s&&(i-=1),d.d&&(n+=.5),d.a&&(n-=.5);const h=i+n,l=i-n;e.tankDrive(h,l,t,o)}function kt(e,t,o){const r=tt();if(r)return _t(r,e,t,o);let i=0,n=0,h=0;d.w&&(i+=1),d.s&&(i-=1),d.d&&(n-=.5),d.a&&(n+=.5),d.ArrowLeft&&(h+=.5),d.ArrowRight&&(h-=.5);const l=i+n+h,a=i-n-h,m=i+n-h,x=i-n+h;e.mecanumDrive(l,a,m,x,t,o)}function c(e){return e/(U/N/(pt*N))*vt}function W(e){return c(e+72)}function O(e){return c(72-e)}function st(e){return(e-90)*(Math.PI/180)}function nt(e){return e*Math.PI/180}function ot(e){return e*180/Math.PI}function f(e,t,o){return Math.max(t,Math.min(o,e))}function ht(e){return(e%360+360)%360}function M(e,t){return Math.abs(e)<t?0:e}function Rt(e){var t=new Image;return t.src=e,t}function p(e){return d[e]&&!u[e]}function Tt(e,t){return!(e.x+e.w<=t.x||t.x+t.w<=e.x||e.y+e.h<=t.y||t.y+t.h<=e.y)}class q{img;obstacles;constructor(t,o=[]){this.img=Rt(t),this.obstacles=o}collision(t){for(const o of this.obstacles)if(Tt(o,t))return!0;return!1}render(){s.drawImage(this.img,0,0,A.width,A.height)}}class J{kp;ki;kd;starti;settleTime;settleError;timeout;maxSpeed=1;minSpeed=0;acculatedError=0;previousError=0;timeSpentSettled=0;timeSpentRunning=0;constructor(t,o,r,i,n,h,l){if(typeof t=="number")this.kp=t,this.ki=o,this.kd=r,this.starti=i,this.settleTime=n,this.settleError=h,this.timeout=l;else{const a=t;this.kp=a.kp,this.ki=a.ki,this.kd=a.kd,this.starti=a.starti,this.settleTime=a.settleTime,this.settleError=a.settleError,this.timeout=a.timeout,this.maxSpeed=a.maxSpeed,this.minSpeed=a.minSpeed}}compute(t){Math.abs(t)<this.starti&&(this.acculatedError+=t),(t>0&&this.previousError<0||t<0&&this.previousError>0)&&(this.acculatedError=0);const o=this.kp*t+this.ki*this.acculatedError+this.kd*(t-this.previousError);return this.previousError=t,Math.abs(t)<this.settleError?this.timeSpentSettled+=10:this.timeSpentSettled=0,this.timeSpentRunning+=10,o}isSettled(){return this.timeSpentRunning>this.timeout&&this.timeout!=0||this.timeSpentSettled>this.settleTime}reset(){this.previousError=0,this.acculatedError=0,this.timeSpentRunning=0,this.timeSpentSettled=0}}const St={maxSpeed:1,minSpeed:0,kp:.4,ki:.03,kd:3,starti:15,settleTime:300,settleError:1,timeout:0},Dt={maxSpeed:.6,minSpeed:0,kp:1.5,ki:0,kd:10,starti:0,settleTime:300,settleError:3,timeout:5e3},Ft={maxSpeed:.8,minSpeed:0,kp:.4,ki:0,kd:1,starti:0,settleTime:300,settleError:1.5,timeout:5e3};class Lt{width;height;maxSpeed;trackWidth;x=0;y=0;angle=0;color;odomData=!0;vL=0;vR=0;maxAccel;maxDecel;constructor(t,o,r,i,n,h,l,a,m){this.x=t,this.y=o,this.angle=r,this.width=i,this.height=n,this.maxSpeed=h,this.trackWidth=l,this.maxAccel=a,this.maxDecel=m,this.color="#969696c4"}set_x(t){this.x=f(t,-72+this.width/2,72-this.width/2)}set_y(t){this.y=f(t,-72+this.height/2,72-this.height/2)}set_angle(t){this.angle=(t%360+360)%360}get_x(){return this.x}get_y(){return this.y}get_angle(){return this.angle}moveTowards(t,o,r){const i=o-t;let h=(Math.abs(o)>Math.abs(t)?this.maxAccel:this.maxDecel)*r;return Math.abs(i)<=h?o:t+Math.sign(i)*h}tankDrive(t,o,r,i){const n=this.trackWidth,h=this.maxSpeed,l=f(t,-1,1),a=f(o,-1,1),m=l*h,x=a*h;this.vL=this.moveTowards(this.vL,m,i),this.vR=this.moveTowards(this.vR,x,i);const w=this.vL*12,P=this.vR*12;let $=(P+w)/2;const B=(w-P)/n,S=this.get_angle(),v=nt(S),D=Math.sin(v),F=Math.cos(v),_=(j,G)=>({x:W(j-this.width/2),y:O(G+this.height/2),w:c(this.width),h:c(this.height)});let y=this.get_x(),L=this.get_y(),k=this.get_x()+$*D*i,R=this.get_y()+$*F*i;r.collision(_(k,R))?(r.collision(_(k,this.get_y()))||(y=k),r.collision(_(this.get_x(),R))||(L=R)):(y=k,L=R);const X=v+B*i;let g=ot(X);g=ht(g),this.set_x(y),this.set_y(L),this.set_angle(g)}draw_odom_data(){this.odomData&&(s.save(),s.font="20px Calibri",s.fillStyle="white",s.textBaseline="top",s.fillText(`θ: ${this.get_angle().toFixed(2)}`,20,20),s.fillText(`X: ${this.get_x().toFixed(2)}`,20,45),s.fillText(`Y: ${this.get_y().toFixed(2)}`,20,70),s.fillText(`vL: ${this.vL.toFixed(2)}`,20,95),s.fillText(`vR: ${this.vR.toFixed(2)}`,20,120),s.fillText(`Velo: ${this.maxSpeed.toFixed(2)}`,20,145),s.fillText(`Accel: ${this.maxAccel.toFixed(2)}`,20,170),s.fillText(`Decel: ${this.maxDecel.toFixed(2)}`,20,195),s.restore())}draw_chassis(){s.save(),s.translate(W(this.x),O(this.y)),s.rotate(st(this.angle)),s.fillStyle=this.color,s.fillRect(-c(this.width)/2,-c(this.height)/2,c(this.width),c(this.height)),s.beginPath(),s.moveTo(0,0),s.lineTo(c(this.width)/2,0),s.strokeStyle="black",s.lineWidth=2,s.stroke(),s.restore()}render(){this.draw_chassis(),this.odomData&&this.draw_odom_data()}}class bt{width;height;maxSpeed;trackWidth;wheelBase;x=0;y=0;angle=0;color;pathTime=0;odomData=!0;vFL=0;vFR=0;vRL=0;vRR=0;maxAccel;maxDecel;constructor(t,o,r,i,n,h,l,a,m,x){this.x=t,this.y=o,this.angle=r,this.width=i,this.height=n,this.maxSpeed=h,this.trackWidth=l,this.wheelBase=a,this.maxAccel=m,this.maxDecel=x,this.color="#1d6408d7"}set_x(t){this.x=f(t,-72+this.width/2,72-this.width/2)}set_y(t){this.y=f(t,-72+this.height/2,72-this.height/2)}set_angle(t){this.angle=(t%360+360)%360}get_x(){return this.x}get_y(){return this.y}get_angle(){return this.angle}moveTowards(t,o,r){const i=o-t;let h=(Math.abs(o)>Math.abs(t)?this.maxAccel:this.maxDecel)*r;return Math.abs(i)<=h?o:t+Math.sign(i)*h}mecanumDrive(t,o,r,i,n,h){const l=f(t,-1,1),a=f(o,-1,1),m=f(r,-1,1),x=f(i,-1,1),w=l*this.maxSpeed,P=a*this.maxSpeed,$=m*this.maxSpeed,B=x*this.maxSpeed;this.vFL=this.moveTowards(this.vFL,w,h),this.vFR=this.moveTowards(this.vFR,P,h),this.vRL=this.moveTowards(this.vRL,$,h),this.vRR=this.moveTowards(this.vRR,B,h);const S=this.vFL*12,v=this.vFR*12,D=this.vRL*12,F=this.vRR*12,_=(S+v+D+F)/4,y=(-S+v+D-F)/4,L=this.wheelBase/2,k=this.trackWidth/2,R=L+k,X=(-S+v-D+F)/(4*R),g=nt(this.get_angle()),j=Math.sin(g),G=Math.cos(g),lt=Math.cos(g),ct=-Math.sin(g),dt=_*j+y*lt,mt=_*G+y*ct,Y=(ft,xt)=>({x:W(ft-this.width/2),y:O(xt+this.height/2),w:c(this.width),h:c(this.height)});let V=this.get_x(),H=this.get_y();const C=this.get_x()+dt*h,I=this.get_y()+mt*h;n.collision(Y(C,I))?(n.collision(Y(C,this.get_y()))||(V=C),n.collision(Y(this.get_x(),I))||(H=I)):(V=C,H=I);const ut=g+X*h;this.set_x(V),this.set_y(H),this.set_angle(ht(ot(ut)))}setPose(t,o,r){this.x=t,this.y=o,this.angle=r}pathFollow(t,o){if(!t.trajectory.length)return;this.pathTime+=o,this.pathTime>t.totalTime&&(this.pathTime=t.totalTime);const r=this.pathTime/t.totalTime,i=Math.floor(r*(t.trajectory.length-1)),n=t.trajectory[i];this.set_x(n.x),this.set_y(n.y),this.set_angle(n.angle)}draw_odom_data(){this.odomData&&(s.save(),s.font="20px Calibri",s.fillStyle="white",s.textBaseline="top",s.fillText(`θ: ${this.get_angle().toFixed(2)}`,20,20),s.fillText(`X: ${this.get_x().toFixed(2)}`,20,45),s.fillText(`Y: ${this.get_y().toFixed(2)}`,20,70),s.fillText(`FL: ${this.vFL.toFixed(2)}`,20,95),s.fillText(`FR: ${this.vFR.toFixed(2)}`,20,120),s.fillText(`RL: ${this.vRL.toFixed(2)}`,20,145),s.fillText(`RR: ${this.vRR.toFixed(2)}`,20,170),s.fillText(`Velo: ${this.maxSpeed.toFixed(2)}`,20,195),s.fillText(`Accel: ${this.maxAccel.toFixed(2)}`,20,220),s.fillText(`Decel: ${this.maxDecel.toFixed(2)}`,20,245),s.restore())}draw_chassis(){s.save(),s.translate(W(this.x),O(this.y)),s.rotate(st(this.angle)),s.fillStyle=this.color,s.fillRect(-c(this.width)/2,-c(this.height)/2,c(this.width),c(this.height)),s.beginPath(),s.moveTo(0,0),s.lineTo(c(this.width)/2,0),s.strokeStyle="black",s.lineWidth=2,s.stroke(),s.restore()}render(){this.draw_chassis(),this.odomData&&this.draw_odom_data()}}let z=new Lt(0,0,0,14,14,6,14,15,15),K=new bt(0,0,0,14,14,6,14,14,15,15),rt=[new q("./push_back_skills.png",[]),new q("./empty_field.png"),new q("./high_stakes_skills.png")];new J(St);new J(Dt);new J(Ft);function Et(e){const t=it(rt);kt(K,t,e),et(K),K.render()}function Mt(e){const t=it(rt);yt(z,t,e),et(z),z.render()}function At(e){Z.useTankDrive?Mt(e):Et(e)}let Q=0;const Pt=60,$t=1e3/Pt;function at(e){let t=e-Q;t>=$t&&(Q=e,At(t/1e3)),window.requestAnimationFrame(at)}at(0);
